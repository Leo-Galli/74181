name: 74181 Workbench

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build-and-profile:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential linux-tools-common linux-tools-generic curl gawk

    - name: Compile 74181.c
      run: gcc -Wall -Wextra -O2 -std=c99 74181.c -o 74181

    - name: Prepare directories
      run: mkdir -p runs logs badges

    - name: Generate test cases
      run: |
        cat <<'EOF' > test_cases.txt
1,S,0,0,0,0,0,0,0,0,0,0,0,0,0
1,S,1,0,1,1,0,1,0,1,1,0,1,0,1
1,N,1,1,1,1,1,1,1,1,1,1,1,1,1
3,1,10,20,30,x
3,2,100,10,x
3,3,7,8,x
3,4,1000,4,x
3,5,(10+2)*3-6
3,5,2*(3+4)
3,5,(10+2*3
3,5,abc+def
3,5,10/0
4,S,101010
4,S,11111111
4,S,0
4,S,102010
4,S,abc101
5,S,42
5,S,255
5,S,0
5,S,-5
5,S,abc
6,S,100,200
6,S,4294967295,1
6,S,0,0
6,S,abc,def
6,S,-1,10
7,S,12345,67890
7,S,1,1
7,S,0,0
7,S,abc,123
8
9
EOF

    - name: Run all test cases
      run: |
        > runs/metrics.csv
        while IFS= read -r line; do
          [[ -z "$line" || "$line" =~ ^# ]] && continue
          input=""
          case "$line" in
            8|9)
              input="$line"$'\n0\n'
              ;;
            1,*)
              vals=$(echo "$line" | cut -d',' -f3-)
              input=$(printf "1\nS\n%s\n0\n" "$(echo "$vals" | tr ',' '\n')")
              ;;
            3,*)
              op=$(echo "$line" | cut -d',' -f2)
              rest=$(echo "$line" | cut -d',' -f3-)
              if [[ "$op" =~ ^[1-4]$ ]]; then
                input=$(printf "3\n%s\n%s\nx\n0\n" "$op" "$(echo "$rest" | tr ',' '\n')")
              else
                input=$(printf "3\n5\n%s\n0\n" "$rest")
              fi
              ;;
            4,*|5,*)
              val=$(echo "$line" | cut -d',' -f3)
              input=$(printf "%s\nS\n%s\n0\n" "$(echo "$line" | cut -d',' -f1)" "$val")
              ;;
            6,*|7,*)
              a=$(echo "$line" | cut -d',' -f3)
              b=$(echo "$line" | cut -d',' -f4)
              input=$(printf "%s\nS\n%s\n%s\n0\n0\n0\n0\n0\n0\n" "$(echo "$line" | cut -d',' -f1)" "$a" "$b")
              ;;
          esac

          echo "ðŸ§ª Running: $line"
          echo "$input" | timeout 15s /usr/bin/time -v ./74181 > "logs/run_${line%%,*}.log" 2>&1 || true

          mem_kb=$(awk '/Maximum resident set size/ {print $6}' "logs/run_${line%%,*}.log")
          cpu_s=$(awk '/User time/ {print $4}' "logs/run_${line%%,*}.log")
          [[ -z "$mem_kb" ]] && mem_kb=0
          [[ -z "$cpu_s" ]] && cpu_s=0.00
          echo "${line%%,*},$cpu_s,$mem_kb" >> runs/metrics.csv
        done < test_cases.txt

    - name: Compute statistics
      run: |
        echo "metric,value" > runs/stats.csv
        if [ -s runs/metrics.csv ]; then
          awk -F',' '
            {cpu+=$2; mem+=$3; n++}
            END {
              if(n>0){
                printf "cpu_avg,%.3f\ncpu_min,%.3f\ncpu_max,%.3f\n", cpu/n, min_cpu, max_cpu
                printf "mem_avg,%.0f\nmem_min,%.0f\nmem_max,%.0f\n", mem/n, min_mem, max_mem
              }
            }
            NR==1 {min_cpu=$2; max_cpu=$2; min_mem=$3; max_mem=$3}
            $2<min_cpu {min_cpu=$2}
            $2>max_cpu {max_cpu=$2}
            $3<min_mem {min_mem=$3}
            $3>max_mem {max_mem=$3}
          ' runs/metrics.csv >> runs/stats.csv
        fi

    - name: Generate badges
      run: |
        mkdir -p badges
        tail -n +2 runs/stats.csv | while IFS=',' read -r metric value; do
          [[ -z "$value" ]] && value="0"
          color="lightgray"
          [[ "$metric" == cpu_* ]] && color="success"
          [[ "$metric" == mem_* ]] && color="informational"
          label="${metric}"
          curl -fsSL "https://img.shields.io/badge/${label}-${value}-${color}?logo=github&logoColor=white&style=for-the-badge" \
            -o "badges/${metric}.svg"
        done

    - name: Commit outputs
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add badges/ runs/ logs/
        git diff --cached --quiet || git commit -m "âœ… Update 74181 Workbench: CPU & Memory badges [skip ci]"
        git push
