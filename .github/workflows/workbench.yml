name: 74181 Workbench

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write   # Per committare i badge

jobs:
  build-and-profile:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential valgrind linux-tools-common linux-tools-generic curl

    - name: Compile 74181.c
      run: gcc -Wall -Wextra -O2 74181.c -o 74181

    - name: Create output directories
      run: |
        mkdir -p runs badges logs

    - name: Define all menu test cases
      run: |
        cat > test_cases.txt <<EOF
        0
        1,S,0,0,0,0,0,0,0,0,0,0,0,0,0
        2,S,0,0,0,0,0,0,0,0,0,0,0,0,0
        3,1,3,5,2,x
        3,2,10,4,x
        3,3,2,3,4,x
        3,4,100,4,x
        3,5,(10+6)*2-4
        3,6
        4,S,1101
        5,S,13
        6,S,255,15,0,0,1,1,0,0
        7,S,65535,1,0,0,1,1,0,0
        8
        9
        EOF

    - name: Run all menu options and collect metrics
      run: |
        INPUT_FILE="test_cases.txt"
        LOG_DIR="logs"
        while IFS=',' read -r line_type args; do
          if [[ "$line_type" == "0" || "$line_type" == "8" || "$line_type" == "9" ]]; then
            echo "Skipping exit or passive command: $line_type"
            continue
          fi

          case "$line_type" in
            1|2|6|7)
              # ALU 74181 or ALU32: expects (S/N) then 14/8 bits
              mode=${args%%,*}
              rest=${args#*,}
              IFS=',' read -ra bits <<< "$rest"
              input="N"  # We skip file creation; use direct echo
              echo "$line_type,$mode,${bits[*]}"
              ;;
            3)
              op=${args%%,*}
              operands=${args#*,}
              case "$op" in
                1|2|3|4)
                  IFS=',' read -ra nums <<< "$operands"
                  input=$(printf "%s\n" "$op" "${nums[@]}" "x")
                  ;;
                5)
                  expr=${operands%,x}
                  input=$(printf "5\n%s\n" "$expr")
                  ;;
                6)
                  input="6"
                  ;;
                *) continue ;;
              esac
              ;;
            4|5)
              mode=${args%%,*}
              value=${args#*,}
              input=$(printf "S\n%s\n" "$value")
              ;;
            *) continue ;;
          esac

          # Construct full input for the program
          full_input=$(printf "%s\n0\n" "$line_type" "$input")

          # Measure with /usr/bin/time -v
          timeout 10s /usr/bin/time -v ./74181 > "$LOG_DIR/run_$line_type.log" 2>&1 <<< "$full_input" || true

          # Extract metrics
          mem_kb=$(grep "Maximum resident set size" "$LOG_DIR/run_$line_type.log" | awk '{print $6}')
          cpu_s=$(grep "User time" "$LOG_DIR/run_$line_type.log" | awk '{print $4}')
          echo "$line_type,$cpu_s,$mem_kb" >> runs/metrics.csv

        done < "$INPUT_FILE"

    - name: Compute stats (min/max/avg)
      run: |
        echo "metric,value" > runs/stats.csv

        # CPU time
        awk -F',' 'NR>1 && $2 != "" && $2 != "0.00" {sum+=$2; if(NR==2||$2<min) min=$2; if($2>max) max=$2; count++} END {if(count>0) {avg=sum/count; print "cpu_avg,"avg; print "cpu_min,"min; print "cpu_max,"max}}' runs/metrics.csv >> runs/stats.csv

        # Memory
        awk -F',' 'NR>1 && $3 != "" && $3 != "0" {sum+=$3; if(NR==2||$3<min) min=$3; if($3>max) max=$3; count++} END {if(count>0) {avg=sum/count; print "mem_avg,"avg; print "mem_min,"min; print "mem_max,"max}}' runs/metrics.csv >> runs/stats.csv

    - name: Generate enhanced badges
      run: |
        mkdir -p badges
        while IFS=',' read -r metric value; do
          if [[ "$metric" == "metric" ]]; then continue; fi
          color="lightgray"
          case "$metric" in
            cpu_*) color="green" ;;
            mem_*) color="blue" ;;
          esac
          label="${metric//_/ }"
          if [[ "$metric" == *"_avg" ]]; then suffix=" (avg)"; fi
          if [[ "$metric" == *"_min" ]]; then suffix=" (min)"; fi
          if [[ "$metric" == *"_max" ]]; then suffix=" (max)"; fi
          curl -s "https://img.shields.io/badge/${label}${suffix}-${value}-${color}?logo=github" -o "badges/${metric}.svg"
        done < runs/stats.csv

    - name: Commit badges and logs to repo
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add badges/ runs/ logs/
        git commit -m "Update 74181 Workbench metrics and badges [skip ci]" || echo "No changes to commit"
        git push
