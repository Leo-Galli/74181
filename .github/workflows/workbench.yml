name: 74181 Workbench

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential valgrind linux-tools-common linux-tools-generic jq curl

    - name: Compile 74181.c
      run: |
        gcc -Wall -O2 74181.c -o 74181

    - name: Run with resource usage
      run: |
        /usr/bin/time -v ./74181 > time.log 2>&1 || true

    - name: Extract metrics
      run: |
        MAX_MEM=$(grep "Maximum resident set size" time.log | awk '{print $6}')
        USER_TIME=$(grep "User time" time.log | awk '{print $4}')
        echo "MAX_MEM=$MAX_MEM" >> $GITHUB_ENV
        echo "USER_TIME=$USER_TIME" >> $GITHUB_ENV

    - name: Generate badge
      run: |
        curl "https://img.shields.io/badge/memory-${MAX_MEM}KB-blue" > memory-badge.svg
        curl "https://img.shields.io/badge/cpu-${USER_TIME}s-green" > cpu-badge.svg

    - name: Upload badges
      uses: actions/upload-artifact@v4
      with:
        name: resource-badges
        path: |
          memory-badge.svg
          cpu-badge.svg
