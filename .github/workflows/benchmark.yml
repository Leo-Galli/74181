name: ALU 74181 Benchmark

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benchmark:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        test_id: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,...,99,100,101,102,103,104]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install psutil anybadge

      - name: Compile simulator
        run: gcc -o simulator simulator.c -O2 -w

      - name: Run benchmark and generate badges
        shell: bash
        run: |
          python3 << 'EOF'
import sys, os, subprocess, psutil, time, json
from anybadge import Badge

test_id = int("${{ matrix.test_id }}")
is_win = os.name == 'nt'
exe = "simulator.exe" if is_win else "./simulator"

inputs = []

# ALU 4-bit: 32 test (M=0/1 × S0-S3=0..15)
for M in [0,1]:
  for i in range(16):
    S3 = (i>>3)&1
    S2 = (i>>2)&1
    S1 = (i>>1)&1
    S0 = i&1
    inp = "1\nN\n" + f"{S3}\n{S2}\n{S1}\n{S0}\n{M}\n0\n0\n0\n0\n0\n0\n0\n0\n"
    inputs.append(inp)

# ALU 32-bit: 32 test (M=0/1 × S0-S3=0..15)
for M in [0,1]:
  for i in range(16):
    S3 = (i>>3)&1
    S2 = (i>>2)&1
    S1 = (i>>1)&1
    S0 = i&1
    inp = "6\nN\n4294967295\n4294967295\n" + f"{S3}\n{S2}\n{S1}\n{S0}\n{M}\n"
    inputs.append(inp)

# ALU 4-bit edge cases: 3
edge4 = [
  "1\nN\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n",
  "1\nN\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n1\n",
  "1\nN\n0\n0\n0\n1\n0\n0\n1\n1\n0\n0\n1\n1\n",
]
inputs.extend(edge4)

# ALU 32-bit edge cases: 4
edge32 = [
  "6\nN\n0\n0\n0\n0\n0\n0\n",
  "6\nN\n4294967295\n0\n0\n0\n0\n0\n",
  "6\nN\n0\n4294967295\n0\n0\n0\n0\n",
  "6\nN\n2147483647\n2147483647\n0\n0\n1\n0\n0\n",
]
inputs.extend(edge32)

# Calculator: 20 expressions
exprs = [
  "2+2", "10-5", "3*7", "15/3", "(2+3)*4", "2**10", "100%7", "1+2+3+4+5",
  "1000000+2000000", "0/1", "1<<5", "0xFF+1", "2147483647+1", "-5+10",
  "(10*(2+3))-7", "((2+2)*2)+2", "100/0", "2+2*2", "1+1", "999999999"
]
for e in exprs:
  inputs.append(f"5\n{e}\n6\n")

# Conversions: 2
inputs.extend(["4\nN\n", "5\nN\n"])

# Ensure we don't exceed input list
if test_id >= len(inputs):
  sys.exit(0)

stdin_data = inputs[test_id]

# Launch and monitor
cpu_vals, ram_vals = [], []
proc = psutil.Popen([exe], stdin=subprocess.PIPE, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
proc.stdin.write(stdin_data.encode())
proc.stdin.close()

start = time.time()
while proc.poll() is None:
  try:
    cpu_vals.append(proc.cpu_percent(interval=0.001))
    ram_vals.append(proc.memory_info().rss / (1024 * 1024))  # MB
  except:
    break
  time.sleep(0.01)
duration = time.time() - start

cpu_avg = sum(cpu_vals) / len(cpu_vals) if cpu_vals else 0
ram_avg = sum(ram_vals) / len(ram_vals) if ram_vals else 0
duration_ms = duration * 1000

os.makedirs("badges", exist_ok=True)
test_name = f"test-{test_id}"

Badge("CPU " + test_name, cpu_avg, {0: "green", 10: "yellow", 30: "orange", 70: "red"}, value_format="%.1f").write_badge(f"badges/cpu-{test_name}.svg", overwrite=True)
Badge("RAM " + test_name, ram_avg, {0: "green", 20: "yellow", 50: "orange", 100: "red"}, value_format="%.1f").write_badge(f"badges/ram-{test_name}.svg", overwrite=True)
Badge("Time " + test_name, duration_ms, {0: "green", 100: "yellow", 500: "orange", 1000: "red"}, value_format="%.0f", label_suffix=" ms").write_badge(f"badges/time-{test_name}.svg", overwrite=True)

with open(f"badges/data-{test_name}.json", "w") as f:
  json.dump({
    "cpu_avg_pct": cpu_avg,
    "ram_avg_mb": ram_avg,
    "duration_sec": duration,
    "os": "${{ matrix.os }}",
    "test_id": test_id
  }, f)

print(f"✅ Test {test_id} completed in {duration:.2f}s")
EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: badges-${{ matrix.os }}-${{ matrix.test_id }}
          path: badges/
          if-no-files-found: ignore
