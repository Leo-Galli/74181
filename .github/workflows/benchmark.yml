name: Benchmark ALU 74181

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '20 20 * * 1'

permissions:
  contents: write
  security-events: write

jobs:

  # --- Build & Test Linux ---
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y build-essential cmake
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release
      - name: Build
        run: cmake --build build --config Release
      - name: Test
        working-directory: build
        run: |
          if [ -f CTestTestfile.cmake ]; then
            ctest -C Release
          else
            echo "No tests defined, skipping"
          fi

  # --- Multipiattaforma Build ---
  build-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]
        include:
          - os: windows-latest
            c_compiler: cl
            cpp_compiler: cl
          - os: ubuntu-latest
            c_compiler: gcc
            cpp_compiler: g++
          - os: ubuntu-latest
            c_compiler: clang
            cpp_compiler: clang++
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: >
          cmake -B build
          -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          -S ${{ github.workspace }}

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: Test
        working-directory: build
        run: |
          if [ -f CTestTestfile.cmake ]; then
            ctest --build-config ${{ matrix.build_type }}
          else
            echo "No tests defined, skipping"
          fi
        shell: bash

  # --- Benchmark multipiattaforma con badges ---
  benchmark:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - run: pip install psutil anybadge

      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build simulator (Linux/macOS)
        if: runner.os != 'Windows'
        run: clang -o simulator 74181.c -O2 -w || gcc -o simulator 74181.c -O2 -w

      - name: Build simulator (Windows)
        if: runner.os == 'Windows'
        run: cl.exe /O2 /Fe:simulator.exe 74181.c advapi32.lib

      - name: Run benchmarks (inline Python)
        shell: python
        run: |
          import os, psutil, subprocess, time, json
          from anybadge import Badge
          from concurrent.futures import ThreadPoolExecutor

          exe = "simulator.exe" if os.name == "nt" else "./simulator"
          os_name = "${{ matrix.os }}"

          TESTS = [
              ("cpu_low",  "5\n2+2\n6\n"),
              ("cpu_high", "5\n(2**30)+(2**30)\n6\n"),
              ("ram_high", "6\nN\n4294967295\n4294967295\n0\n0\n")
          ]

          def run_test(name, stdin_data):
              proc = psutil.Popen(
                  [exe],
                  stdin=subprocess.PIPE,
                  stdout=subprocess.DEVNULL,
                  stderr=subprocess.DEVNULL
              )
              proc.stdin.write(stdin_data.encode())
              proc.stdin.close()

              start = time.perf_counter()
              proc.wait()
              duration = (time.perf_counter() - start) * 1000

              try:
                  cpu = proc.cpu_percent()
                  ram = proc.memory_info().rss / (1024 * 1024)
              except:
                  cpu = 0
                  ram = 0

              return cpu, ram, duration

          with ThreadPoolExecutor(max_workers=3) as pool:
              results = list(pool.map(lambda t: run_test(*t), TESTS))

          cpu_avg = sum(r[0] for r in results) / 3
          ram_avg = sum(r[1] for r in results) / 3
          time_avg = sum(r[2] for r in results) / 3

          os.makedirs("badges", exist_ok=True)

          Badge(label=f"CPU {os_name}", value=cpu_avg,
                thresholds={0:"green",10:"yellow",30:"orange",70:"red"},
                value_format="%.1f").write_badge(f"badges/cpu-summary-{os_name}.svg", overwrite=True)

          Badge(label=f"RAM {os_name}", value=ram_avg,
                thresholds={0:"green",20:"yellow",50:"orange",100:"red"},
                value_format="%.1f").write_badge(f"badges/ram-summary-{os_name}.svg", overwrite=True)

          Badge(label=f"Tempo(ms) {os_name}", value=time_avg,
                thresholds={0:"green",100:"yellow",500:"orange",1000:"red"},
                value_format="%.0f").write_badge(f"badges/time-summary-{os_name}.svg", overwrite=True)

          with open(f"badges/data-summary-{os_name}.json", "w") as f:
              json.dump({
                  "cpu_avg_pct": cpu_avg,
                  "ram_avg_mb": ram_avg,
                  "time_avg_ms": time_avg,
                  "os": os_name,
                  "tests_run": 3
              }, f)

      - name: Commit badges
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add badges/
          git commit -m "Update summary badges for ${{ matrix.os }}" || echo "No changes"
          git push

  # --- MSVC Code Analysis ---
  code-analysis:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: cmake -S ${{ github.workspace }} -B build

      - name: Build Project
        run: cmake --build build --config Release

      - name: Initialize MSVC Code Analysis
        uses: microsoft/msvc-code-analysis-action@04825f6d9e00f87422d6bf04e1a38b1f3ed60d99
        id: run-analysis
        with:
          cmakeBuildDirectory: build
          ruleset: NativeRecommendedRules.ruleset

      - name: Upload SARIF to GitHub
        if: steps.run-analysis.outputs.sarif != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.run-analysis.outputs.sarif }}

      - name: Run Executable
        run: |
          if (Test-Path .\build\Release\74181.exe) {
            echo 0 | .\build\Release\74181.exe
          } else {
            Write-Output "Executable not found, skipping run"
          }
        shell: pwsh
